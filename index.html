<html lang="en" ng-app="eimodule">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UNDP Extractive Industries Data Dive</title>

    <!-- Load c3.css Style -->
    <link href="css/c3.css" rel="stylesheet" type="text/css">

    <!-- Bootstrap Style -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <style>
          
        #chart2 .c3-line-econ_gdpcon {
          stroke-width: 0px;
        }
        #chart2 .c3-line-econ_gdpconpc {
          stroke-width: 0px;
        }
        #chart2 .c3-line-econ_tax {
          stroke-width: 0px;
        }
        #chart2 .c3-line-rev_gov_resrev_govtrev {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_nonresrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_rev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rent_total_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_govt_take {
          stroke-width: 0px;
        }
    </style>

   
  </head>
  <body ng-controller="ei_countrySelect_control">

    <!-- For D3 -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!-- For TopoJSON and DataMaps -->
    <script src='http://d3js.org/topojson.v1.min.js' type='text/javascript'></script>
    <script src='http://datamaps.github.io/scripts/datamaps.all.min.js' type='text/javascript'></script>
    <!-- Load c3.js -->
    <script src="js/c3.min.js"></script>
    <!-- Load angular.js -->
    <script src='http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js' type='text/javascript'></script>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Extractive Industries and Development</h1>
        <p>How are countries transforming natural capital into economic and human development?</p>
      </div>
    </div>

    
    <!-- Set up our Bootstrap Layout Grid -->
    <div class="container">
      <div class="row">
        <div class="col-md-2 text-left"><h3>The Countries</h3>Resource dependence, resource wealth, and the disrtibution of that wealth vary widely across countries, and by type of country.
          Click on country, or select a group.
        </div> 
        <div class="col-md-10 text-left" style="height: 350px;"><div id='chart1'></div></div> 
      </div>
      <div class="row">      
        <div class="col-md-12 text-left"><h3 ng-bind='current_country_name'></div> 
      </div>
      
      <div class="row">      
        <div class="col-md-12 text-left"><div id='chart2'></div> 
      </div>
    </div>


    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!-- <script src="http://code.jquery.com/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    
    <script>
    
    // ----------------------------------------------------------------------
    // This is Angular Setup
    // ----------------------------------------------------------------------
  
   
    var eimod = angular.module('eimodule',[]);
    
    eimod.factory("eifactory", function($http) {
      var factory = {};    
      
      factory.getRawData = function() {
        return $http.get('eidata.json');      
      };  
      factory.getGroupsData = function() {
        return $http.get('eigroups.json');      
      };  
      
    return factory;      
    });


    eimod.controller("ei_countrySelect_control", function($scope, eifactory) {
      
      console.log("in controller");
      
      $scope.raw_data = [];
      $scope.country_names = [];
      $scope.country_data_json = [];
      $scope.country_macro_stat_data_json = [];
      $scope.country_resource_stat_data_json = [];
      $scope.country_resource_stat_data_arr = [];
      $scope.current_country_name = "";
      
      $scope.dataMapFillKeys = {};
      
      var xaxis = ["x",2000, 2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012];
      
      
      $scope.chart1 = {};      
      $scope.chart2 = null;
      $scope.datamap = null;
      
      //var chart2 = {};
      
      //console.log($scope.current_country_id);
      
      eifactory.getRawData().success(function(data) {
        
          console.log("in get data success");
  
          //raw_eidata = data;
          //console.log(data);
          $scope.raw_data = data;
          console.log("raw data: ");
          console.log($scope.raw_data);
      
          $scope.raw_data.forEach(function(countryObj, index) {
            $scope.country_data_json[countryObj.country.ccode] = countryObj.country;
            $scope.country_macro_stat_data_json[countryObj.country.ccode] = countryObj.macroStats;
            $scope.country_resource_stat_data_json[countryObj.country.ccode] = countryObj.resourceStats;            
            //$scope.country_macro_stat_data_json[countryObj.country.ccode]["x"] = [2000, 2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012];
            $scope.country_resource_stat_data_json[countryObj.country.ccode]["x"] = [2000, 2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012];
          }); 
          
          console.log("country json data: ");
          console.log($scope.country_data_json);  
          console.log("country macro stat json data: ");
          console.log($scope.country_macro_stat_data_json);  
          console.log("country resource stat json data: ");
          console.log($scope.country_resource_stat_data_json);  
          
      
          $scope.raw_data.forEach(function(countryObj, index) {
                       
            var statData = Object();
            $scope.country_resource_stat_data_arr[countryObj.country.ccode] = [];
            $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(xaxis);
            
            
            for (var statname in countryObj.resourceStats) {
              //console.log(countryObj.resourceStats);
              //console.log(statname);
              var tmp=[];
              tmp.push(statname);
              statData[statname] = tmp.concat(countryObj.resourceStats[statname]);
              $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(statData[statname]);            
            }

          });
          console.log("country arr data: ");
          console.log($scope.country_resource_stat_data_arr);  
          
          console.log("before loop: ");
          // this object will be passed to data map
          $scope.country_data_json.forEach(function(countryObj, index) {
            console.log("testing for resource stats");
            if (countryObj.haveResourceStats == "1") {
              console.log("has stats");
              $scope.dataMapFillKeys[countryObj.ccode] = "haveResourceStats";
            }  
            else   
              $scope.dataMapFillKeys[countryObj.ccode] = "defaultFill";  
          });
          console.log($scope.dataMapFillKeys);
          
      /*    
          $scope.raw_data.forEach(function(countryObj, index) {
            $scope.country_names.push(countryObj.ccode);
          });
          */
          //console.log($scope.country_names);  
          //console.log($scope.country_data_json[$scope.current_country_id]);

          $scope.current_country_id = "AGO";
          $scope.current_country_name = $scope.country_data_json[$scope.current_country_id]["name"];

          $scope.chart2 = c3.generate({
              
                  bindto: '#chart2',              
                  size: {
                    height: 300,
                  },                      
                  data: {
                    x: 'x',
                    json: $scope.country_resource_stat_data_json[$scope.current_country_id],
                    axes: { rev_gov_resrev_govtrev : 'y',calc_gov_resrev_gdp : 'y',rev2_gov_nonresrev_gdp : 'y',rev2_gov_rev_gdp : 'y', rent_total_gdp : 'y', calc_govt_take: 'y2' },
                    /*
                    axes: { econ_gdpcon : 'y2',econ_gdpconpc : 'y2',econ_tax : 'y2',econ_govrev : 'y2',econ_govexp : 'y2',econ_invtotal : 'y2',rev_gov_resrev_govtrev : 'y',rev_gov_resrev_gdp : 'y',rev2_gov_nonresrev_gdp : 'y',rev2_gov_resrev_gdp : 'y',rev2_gov_rev_gdp : 'y',rent_total : 'y'},
                    */
                    type: 'line',
                    types: {
                        calc_govt_take: 'area',
                    },
                    names: {
                      econ_gdpcon: 'GDP (constant $)',
                      econ_gdpconpc: 'GDP per capita (constant $)',
                      econ_tax: 'Total Govt Tax Rev (% GDP)',
                      econ_govrev: 'Total Govt Rev (% GDP) [econ]',
                      econ_govexp: 'Total Govt Expenditure (% GDP)',
                      econ_invtotal: 'Total Investments (% GDP)',
                      rev_gov_resrev_govtrev: 'Govt Res Rev. (% Govt Rev.)',
                      rev_gov_resrev_gdp: 'Govt Res Rev. (% GDP) [rev]',
                      rev2_gov_nonresrev_gdp: 'Govt Non-Res Rev. (% GDP)', 
                      rev2_gov_resrev_gdp: 'Govt Res Rev. (% GDP) [rev2]',
                      rev2_gov_rev_gdp: 'Govt Rev. (% GDP) [rev2]',
                      rent_total: 'Total Rent (% GDP)'                  
                    },
                    colors: {
                      econ_gdpcon: '#B6B6B4',
                      econ_gdpconpc: '#B6B6B4',
                      econ_tax: '#B6B6B4',
                      econ_govrev: '#B6B6B4',
                      econ_govexp: '#B6B6B4',
                      econ_invtotal: '#B6B6B4',                  
                      calc_govt_take: '#B6B6B4',                  
                    },
                  }, // data  
                  axis: {
                    y: {
                      max: 100,
                      min: 0,
                      padding: {top:0, bottom:0},
                      label: {
                        text: 'Resource Statistics: % of GDP',
                        position: 'outer-middle'
                      },                      
                    },
                    y2: { max: 1.5, min: 0},
                    x: { min: 2000, max:2011}
                
                  }, // axis
              
                 legend: {
                    position: 'right'
                  },
                  
          });// c3.generate
          
          //console.log($scope.chart2);
          
          
          
          $scope.chart1 = new Datamap({
              element: document.getElementById('chart1'),
              scope: "world",
              fills: {
                defaultFill: "#eee",
                haveResourceStats: "#fa0fa0",
              },
              "done": function(datamap) {
                  console.log("in done");
                  //$scope.datamap = datamap;
                  console.log($scope.datamap);
                  datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography, data) {
                    //console.log("in on click datamap");
                    $scope.current_country_id = geography.id;
                    //$scope.current_country = $scope.country_data_json[geography.id];
                    //console.log("current_country");
                    //console.log($scope.current_country);
                    $scope.$apply();
                    //if ($scope.chart2 != null) $scope.chart2.load({ json: $scope.current_country });
                    //$scope.setCurId(geography.id);
                                        
                  });
              } // done               
          }); // chart1 
          
    
      }).error(function(err){
          throw(err);   
      }); // getData
          
     $scope.$watch('current_country_id', function(newValue, oldValue) {
        console.log('watch current_country_id:');
        console.log(newValue);
        $scope.current_country_name = $scope.country_data_json[newValue]["name"];
        if ($scope.chart2 != null) $scope.chart2.load({ columns: $scope.country_resource_stat_data_arr[newValue] });
         
      }, true); 
            
      
    }); // controller
    
    </script>
    
    


  </body>
</html>