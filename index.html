<html lang="en" ng-app="eimodule" ng-init="current_country_id='AGO'">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UNDP Extractive Industries Data Dive</title>

    <!-- Load c3.css Style -->
    <link href="css/c3.css" rel="stylesheet" type="text/css">

    <!-- Bootstrap Style -->
    <link href="css/bootstrap.min.css" rel="stylesheet">  
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <style>
        
        .btn {
          margin-bottom: 5;
          margin-left: 5;
          margin-right: 5;
          background-color: '#fff';
        }
        h3 {
           margin-top:5px; margin-bottom:5px;
        }
          
        #chart2 .c3-line-econ_gdpcon {
          stroke-width: 0px;
        }
        #chart2 .c3-line-econ_gdpconpc {
          stroke-width: 0px;
        }
        #chart2 .c3-line-econ_tax {
          stroke-width: 0px;
        }
        #chart2 .c3-line-rev_gov_resrev_govtrev {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_nonresrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_gov_resrev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rev2_gov_rev_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-rent_total_gdp {
          stroke-width: 4px;
        }
        #chart2 .c3-line-calc_govt_take {
          stroke-width: 0px;
        }
    </style>

   
  </head>
  <body ng-controller="ei_countrySelect_control">
  
    <!-- For D3 -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!-- For TopoJSON and DataMaps -->
    <script src='http://d3js.org/topojson.v1.min.js' type='text/javascript'></script>
    <script src='http://datamaps.github.io/scripts/datamaps.all.min.js' type='text/javascript'></script>
    <!-- Load c3.js -->
    <script src="js/c3.min.js"></script>
    
    <!--
    <script src="http://c3js.org/js/c3.min-631d1d50.js"></script>
    -->
    <!-- Load angular.js -->
    <script src='http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js' type='text/javascript'></script>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Extractive Industries and Development</h1>
        <p>How are countries transforming natural capital into economic and human development?</p>
      </div>
    </div>

    
    <!-- Set up our Bootstrap Layout Grid -->
    <div class="container">
      <div class="row">
        <div class="col-md-2 text-left">
          <h3>The Countries</h3>Resource dependence, resource wealth, and the distribution of resource wealth vary widely across countries.<br>
           Click on a country to see its data below. 
           Filled countries have resource data available. <br>
      </div>
        <div class="col-md-8 text-left" style="height: 360px;">
          <div id='chart1'></div>            
        </div> 
        <div class="col-md-2 text-left">
          <h5>Putting Comparisons <br>on the Map</h5>
          Click to fill countries by<br> 
          <div class="btn-group btn-group-xs btn-group-vertical">
                <button class="btn btn-mini" ng-click="updateChloroFillsForStat('calc_govt_take')">Government Take</button>
                <button class="btn btn-mini" ng-click="updateChloroFillsForStat('rent_total_gdp')">Total Rent</button>
                <button class="btn btn-mini" ng-click="updateChloroFillsForStat('calc_gov_resrev_gdp')">Government Resource Revenue</button>               
          </div>
          Fill colors are based on an average of yearly values.<br> 
          <div class="btn-group btn-group-xs btn-group-vertical">
                <button class="btn btn-mini" ng-click="updateChloroFillsForStat('default')">Reset</button>
          </div>
        </div>        
      </div>        
      <div class="row">      
        <div class="col-md-2 text-left"><h3 ng-bind='current_country_name'></div>       
        <div class="col-md-8 text-left"><div id='chart2'></div></div> 
        <div class="col-md-2 text-left">More Visual Here</div>       
      </div>
    </div>


    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!-- <script src="http://code.jquery.com/jquery.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    
    <script>
    
    // ----------------------------------------------------------------------
    // This is Angular Setup
    // ----------------------------------------------------------------------
  
   
    var eimod = angular.module('eimodule',[]);
    
    eimod.factory("eifactory", function($http) {
      var factory = {};    
      
      factory.getRawData = function() {
        return $http.get('eidata.json');      
      };  
      
    return factory;      
    });


    eimod.controller("ei_countrySelect_control", function($scope, eifactory) {
      
      console.log("in controller");
      
      $scope.raw_data = [];
      $scope.country_names = [];
      $scope.country_data_json = [];
      $scope.country_macro_stat_data_json = [];
      $scope.country_resource_stat_data_json = [];
      $scope.country_resource_stat_data_arr = [];
      $scope.current_country_name = "";
      
      $scope.dataMapFillKeys = {};
      
      var xaxis = ["x",2000, 2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012];
      
      
      $scope.chart1 = {};      
      $scope.chart2 = null;
      $scope.datamap = null;
      
      //var chart2 = {};
      
      //console.log($scope.current_country_id);
      
      eifactory.getRawData().success(function(data) {
        
          console.log("in get data success");
  
          //raw_eidata = data;
          //console.log(data);
          $scope.raw_data = data;
          console.log("raw data: ");
          console.log($scope.raw_data);
      
          $scope.raw_data.forEach(function(countryObj, index) {
            $scope.country_data_json[countryObj.country.ccode] = countryObj.country;
            $scope.country_macro_stat_data_json[countryObj.country.ccode] = countryObj.macroStats;
            $scope.country_resource_stat_data_json[countryObj.country.ccode] = countryObj.resourceStats;            
            //$scope.country_macro_stat_data_json[countryObj.country.ccode]["x"] = [2000, 2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012];
            //$scope.country_resource_stat_data_json[countryObj.country.ccode]["x"] = [2000, 2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011, 2012];
          }); 
          
          console.log("country json data: ");
          console.log($scope.country_data_json);  
          console.log("country macro stat json data: ");
          console.log($scope.country_macro_stat_data_json);  
          console.log("country resource stat json data: ");
          console.log($scope.country_resource_stat_data_json);  
          
      
          $scope.raw_data.forEach(function(countryObj, index) {
                       
            var statData = Object();
            $scope.country_resource_stat_data_arr[countryObj.country.ccode] = [];
            $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(xaxis);
            
            
            for (var statname in countryObj.resourceStats) {
              //console.log(countryObj.resourceStats);
              //console.log(statname);
              var tmp=[];
              tmp.push(statname);
              statData[statname] = tmp.concat(countryObj.resourceStats[statname]);
              $scope.country_resource_stat_data_arr[countryObj.country.ccode].push(statData[statname]);            
            }

          });
          console.log("country arr data: ");
          console.log($scope.country_resource_stat_data_arr);  
          
          // this object will be passed to data map
          for (countryObjKey in $scope.country_data_json) {
          //$scope.country_data_json.forEach(function(countryObj, index) {
            //console.log("testing for resource stats");
            //console.log($scope.country_data_json[countryObjKey]);
            $scope.dataMapFillKeys[countryObjKey] = {};
            if ($scope.country_data_json[countryObjKey].haveResourceStats == "1") {
              //console.log("has stats");
              $scope.dataMapFillKeys[countryObjKey].fillKey = "haveResourceStats";
            }  
            else   
              $scope.dataMapFillKeys[countryObjKey].fillKey = "defaultFill";  
          }
          console.log("dataMapFillKeys:");
          console.log($scope.dataMapFillKeys);
          
          $scope.current_country_name = $scope.country_data_json[$scope.current_country_id]["name"];

          $scope.chart2 = c3.generate({
              
                  bindto: '#chart2',              
                  size: {
                    height: 300,
                  },   
                 data: {
                    x: 'x',
                    columns: $scope.country_resource_stat_data_arr[$scope.current_country_id],
                    axes: { rev_gov_resrev_govtrev : 'y',calc_gov_resrev_gdp : 'y',rev2_gov_nonresrev_gdp : 'y',rev2_gov_rev_gdp : 'y', rent_total_gdp : 'y', calc_govt_take: 'y2' },
                    type: 'line',
                    types: {
                        calc_govt_take: 'area',
                    },
                    names: {
                      econ_gdpcon: 'GDP (constant $)',
                      econ_gdpconpc: 'GDP per capita (constant $)',
                      econ_tax: 'Total Govt Tax Rev (% GDP)',
                      econ_govrev: 'Total Govt Rev (% GDP) [econ]',
                      econ_govexp: 'Total Govt Expenditure (% GDP)',
                      econ_invtotal: 'Total Investments (% GDP)',
                      rev_gov_resrev_gdp: 'Govt Resource Rev. (% GDP)',
                      rev2_gov_resrev_gdp: 'Govt Resource Rev. (% GDP)',
                      rev_gov_resrev_govtrev: 'Govt Resource Revenue (% Govt Rev.)',
                      calc_gov_resrev_gdp: 'Govt Resource Revenue (% GDP) ',
                      rev2_gov_nonresrev_gdp: 'Govt Non-Resource Revenue (% GDP)', 
                      rev2_gov_rev_gdp: 'Govt Revenue (% GDP)',
                      rent_total_gdp: 'Total Rent (% GDP)',
                      calc_govt_take: 'Government Take Ratio'
                    },
                    colors: {
                      rev_gov_resrev_govtrev: '#5ab75c',
                      rev2_gov_nonresrev_gdp: '#4aafcd', 
                      calc_gov_resrev_gdp: '#016ecd',
                      rev2_gov_rev_gdp: '#a631fa',
                      rent_total_gdp: '#da4f4a',
                      calc_govt_take: '#a6a6a6'
                    },
                  }, // data  
                  axis: {
                    y: {
                      max: 100,
                      min: 0,
                      padding: {top:0, bottom:5},
                      label: {
                        text: 'Percent',
                        position: 'outer-middle'
                      },                      
                    },
                    y2: { max: 1.4, 
                          min: 0, 
                          padding: {top:0, bottom:.2},
                    },
                    x: { min: 2000, max:2011,
                    }
                
                  }, // axis
              
                 legend: {
                    position: 'bottom'
                  },
                  
          });// c3.generate
          
          //console.log($scope.chart2);
          
          
          function getTimeSeriesAverageByCountry(ccode, statname) {
            //console.log("getting avg" + statname);
            //console.log($scope.country_macro_stat_data_json[ccode]);
            if ($scope.country_macro_stat_data_json[ccode][statname]) {
              return d3.mean($scope.country_macro_stat_data_json[ccode][statname]);    
            }  
            else if ($scope.country_resource_stat_data_json[ccode][statname]) {
              return d3.mean($scope.country_resource_stat_data_json[ccode][statname]);                    
            }
            else 
              return null;            
          };              
          
          function getTimeSeriesAverage(statName) {
            var statData = {};
            for (countryObjKey in $scope.country_data_json) {
              statData[countryObjKey] = getTimeSeriesAverageByCountry(countryObjKey, statName);    
            }
            console.log(statData);
            return statData;
          };
                    
          $scope.updateChloroFillsForStat = function(statName) {
            console.log("updating choro");
            
            if(statName == "default") {
              $scope.chart1.updateChoropleth($scope.dataMapFillKeys);
            }           
              else {
              var countryVals = {};
              countryVals = getTimeSeriesAverage(statName);
              
              var vals = [];
              for(key in countryVals) {
                vals.push(countryVals[key]);
              }            
              
              var color = d3.scale.linear()
                           .domain([d3.min(vals),d3.max(vals)])
                           .range(["#ffead6", "#faa632"]); //faa632 #ffbb78 b28254
              
              var chloroVals = {};
              for(key in countryVals) {
                if (countryVals[key] == null) {
                    chloroVals[key] = "#eee";
                }
                else
                    chloroVals[key] = color(countryVals[key]);
              }
              $scope.chart1.updateChoropleth(chloroVals);
            }
            
          };
          
          
          $scope.chart1 = new Datamap({
              element: document.getElementById('chart1'),
              scope: "world",
              fills: {
                defaultFill: "#eee",
                haveResourceStats: "#ffbb78", //#faa632
              },
              data: $scope.dataMapFillKeys,              
              "done": function(datamap) {
                  console.log("in done");
                  //$scope.datamap = datamap;
                  console.log($scope.datamap);
                  datamap.svg.selectAll('.datamaps-subunit').on('click', function(geography, data) {
                    //console.log("in on click datamap");
                    $scope.current_country_id = geography.id;
                    //$scope.current_country = $scope.country_data_json[geography.id];
                    //console.log("current_country");
                    //console.log($scope.current_country);
                    $scope.$apply();
                    //if ($scope.chart2 != null) $scope.chart2.load({ json: $scope.current_country });
                    //$scope.setCurId(geography.id);
                                        
                  });
              }, // done
              geographyConfig: {
                highlightOnHover: true,
                highlightFillColor: '#ff7f0e',
                //highlightBorderColor: '#ff7f0e',
                //highlightBorderWidth: 5,
              }
          }); // chart1 
          //console.log($scope.chart1);
          
          // initial implementation
          //createChloroKeysForStat("calc_govt_take");
          //createChloroKeysForStat("rent_total_gdp");
                    

    
      }).error(function(err){
          throw(err);   
      }); // getData
          
     $scope.$watch('current_country_id', function(newValue, oldValue) {
        console.log('watch current_country_id:');
        console.log(newValue);
        //console.log($scope.country_data_json);
        //console.log($scope.country_data_json[newValue]);
        
        if ($scope.country_data_json[newValue] != null) {
          console.log($scope.country_data_json[newValue]);
          $scope.current_country_name = $scope.country_data_json[newValue]["name"];
          
        }    
        if ($scope.chart2 != null) $scope.chart2.load({ columns: $scope.country_resource_stat_data_arr[newValue] });
         
      }, true); 
            
      
    }); // controller
    
    </script>
    
    


  </body>
</html>